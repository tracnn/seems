# üìò `cursor-rules.md`
### **qSEEMS Backend ‚Äì MDC + Scaffold Prompt**
### **Monorepo + pnpm + NestJS Microservice + UUID + CQRS + Oracle + Swagger + Winston/Seq**

# ======================================================================
# üß± **PH·∫¶N 1 ‚Äì MDC (B·ªò QUY T·∫ÆC X√ÇY D·ª∞NG BACKEND qSEEMS)**
# ======================================================================

# 0) M·ª§C TI√äU  
Cursor ph·∫£i x√¢y d·ª±ng h·ªá th·ªëng backend qSEEMS theo c√°c nguy√™n t·∫Øc sau:

- **Monorepo + pnpm workspace**  
- Ki·∫øn tr√∫c **microservice ƒë·ªôc l·∫≠p**  
- **NestJS chu·∫©n**, KH√îNG s·ª≠ d·ª•ng DDD  
- **CQRS to√†n b·ªô use-case**  
- **UUID v4** l√†m primary key  
- **Oracle XE** (TypeORM + oracledb)  
- **Swagger/OpenAPI ƒë·∫ßy ƒë·ªß**  
- **Winston + Seq logging**  
- **Docker Compose** ch·∫°y ƒë∆∞·ª£c ngay  
- Code d·ªÖ ƒë·ªçc, r√µ r√†ng, d·ªÖ m·ªü r·ªông

---

# 1) T·ªîNG TH·ªÇ H·ªÜ TH·ªêNG  

H·ªá th·ªëng c√≥ 4 service:

### 1. `api-gateway`
- NestJS HTTP  
- JWT guard  
- RBAC guard  
- Reverse proxy ‚Üí service kh√°c  
- Rate limit  
- Logging request  
- Swagger  
- Kh√¥ng ch·ª©a logic nghi·ªáp v·ª•  

### 2. `auth-service`
- Login  
- Refresh token  
- Argon2 hashing  
- C·∫•p JWT HS256  
- CQRS  

### 3. `iam-service`
- Users  
- Roles  
- Permissions  
- Assign role  
- CQRS  
- Oracle  

### 4. `catalog-service`
- Stations  
- Ambulances  
- Crews  
- Equipment  
- CRUD  
- CQRS  
- Oracle  

T·∫•t c·∫£ service ƒë·ªôc l·∫≠p ho√†n to√†n, giao ti·∫øp qua **HTTP th√¥ng qua api-gateway**.

---

# 2) C·∫§U TR√öC FOLDER CHU·∫®N NESTJS (b·∫Øt bu·ªôc)

M·ªói service ph·∫£i theo chu·∫©n:

```
src/
  main.ts
  app.module.ts

  modules/
    <module>/
      <module>.module.ts
      controllers/
      services/
      dtos/
      entities/
      repositories/
      cqrs/
        commands/
        queries/
      guards/
      interceptors/
      filters/
```

**KH√îNG d√πng DDD**  
**KH√îNG t·∫°o domain/application/infrastructure layers**

---

# 3) CQRS (b·∫Øt bu·ªôc)

C·∫•u tr√∫c:

```
modules/<module>/cqrs/commands/create-xxx.command.ts
modules/<module>/cqrs/commands/create-xxx.handler.ts
modules/<module>/cqrs/queries/get-xxx.query.ts
modules/<module>/cqrs/queries/get-xxx.handler.ts
```

- Command = ghi (create/update/delete)  
- Query = ƒë·ªçc (get/list)  
- Handler d√πng `@CommandHandler`, `@QueryHandler`  

---

# 4) ORACLE + TYPEORM (b·∫Øt bu·ªôc)

### KH√îNG d√πng sequence + trigger  
‚Üí S·ª≠ d·ª•ng UUID cho ID

### Entity chu·∫©n UUID:

```ts
@PrimaryGeneratedColumn("uuid")
id: string;
```

### C·ªôt Oracle t∆∞∆°ng ·ª©ng:

```
VARCHAR2(36 CHAR)
```

### Migration m·∫´u:

```sql
CREATE TABLE USERS (
  ID VARCHAR2(36 CHAR) PRIMARY KEY,
  USERNAME VARCHAR2(255 CHAR) NOT NULL,
  PASSWORD VARCHAR2(255 CHAR) NOT NULL,
  FULL_NAME VARCHAR2(255 CHAR),
  IS_ACTIVE NUMBER(1) DEFAULT 1 NOT NULL
);
```

### KH√îNG ƒê∆Ø·ª¢C D√ôNG:
- NUMBER PRIMARY KEY  
- AUTO_INCREMENT  
- SEQUENCE  
- TRIGGER BEFORE INSERT  

---

# 5) LOGGING ‚Äì WINSTON + SEQ (b·∫Øt bu·ªôc)

### Format:
- JSON  
- timestamp  
- level  
- context  
- requestId  
- userId (n·∫øu c√≥)  

### Transport:
- console  
- file `logs/`  
- Seq (`@datalust/winston-seq`)  

### ENV:
```
SEQ_URL=http://seq:5341
SEQ_API_KEY=
```

### Middleware start/end request:
- G·∫Øn requestId  
- Log method, url  
- Log response time  
- Log userId  

---

# 6) API GATEWAY (b·∫Øt bu·ªôc)

- JWT validation  
- RBAC guard  
- Reverse proxy d√πng Axios  
- Rate-limit (NestJS Throttler)  
- Logging  
- Kh√¥ng ch·ª©a logic nghi·ªáp v·ª•  

### Routing:
```
/auth        ‚Üí auth-service
/iam         ‚Üí iam-service
/resources   ‚Üí catalog-service
```

---

# 7) VALIDATION

- D√πng `class-validator` + `class-transformer`  
- Validate t·∫°i controller  
- DTO ph·∫£i c√≥ decorator ƒë·∫ßy ƒë·ªß  
- Kh√¥ng validate t·∫°i service  

---

# 8) ERROR HANDLING

T·∫°o filter:

```
HttpExceptionFilter
```

Format l·ªói chu·∫©n:

```json
{
  "success": false,
  "errorCode": "VALIDATION_ERROR",
  "message": "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá",
  "timestamp": "2025-01-01T12:00:00Z",
  "path": "/iam/users"
}
```

---

# 9) ENV (b·∫Øt bu·ªôc)

```
PORT=
DB_HOST=
DB_PORT=
DB_SID=
DB_USER=
DB_PASS=
JWT_SECRET=
SEQ_URL=
SEQ_API_KEY=
SWAGGER_TITLE=
SWAGGER_DESC=
API_VERSION=
```

---

# 10) Y√äU C·∫¶U T·ª™NG SERVICE (r√∫t g·ªçn do gi·ªõi h·∫°n)
(auth, iam, catalog ‚Äì nh∆∞ ƒë√£ m√¥ t·∫£ ƒë·∫ßy ƒë·ªß ·ªü tr√™n)

---

# 11) DOCKER COMPOSE (r√∫t g·ªçn)

Bao g·ªìm:
- api-gateway  
- auth-service  
- iam-service  
- catalog-service  
- oracle-xe  
- seq  

---

# 12) SWAGGER

- `/docs`, `/docs-json`  
- JWT BearerAuth  
- DTO c√≥ decorator `@ApiProperty()`  
- Tag theo module  

---

# 13) LIBS COMMON

Ch·ª©a filter, middleware, interceptor chung.

---

# 14) TI√äU CHU·∫®N CODE  
- Kh√¥ng d√πng any  
- Kh√¥ng logic trong controller  
- Service x·ª≠ l√Ω nghi·ªáp v·ª•  

---

# 15) CURSOR PH·∫¢I SINH RA  
- Monorepo  
- pnpm  
- 4 services  
- libs/common  
- CQRS  
- UUID Entities  
- Oracle migrations  
- Swagger  
- Winston + Seq  
- Dockerfile  
- docker-compose  
- Seed admin  
- README  

---

# ======================================================================
# PH·∫¶N 2 ‚Äì PROMPT KH·ªûI T·∫†O D·ª∞ √ÅN
# ======================================================================

(H∆∞·ªõng d·∫´n t·∫°o monorepo, services, cqrs, docker, swagger, seed ‚Äî ƒë·∫ßy ƒë·ªß nh∆∞ ph·∫ßn tr∆∞·ªõc)

---

# ======================================================================
# ‚úîÔ∏è K·∫æT TH√öC
# ======================================================================

