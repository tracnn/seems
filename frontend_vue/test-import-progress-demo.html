<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Import Progress Dialog</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/primevue@3/core/core.min.js"></script>
    <script src="https://unpkg.com/primevue@3/button/button.min.js"></script>
    <script src="https://unpkg.com/primevue@3/dialog/dialog.min.js"></script>
    <script src="https://unpkg.com/primevue@3/progressbar/progressbar.min.js"></script>
    <script src="https://unpkg.com/primeicons/primeicons.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .p-dialog {
            border-radius: 12px;
        }
        .p-progressbar {
            border-radius: 8px;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="p-8">
            <h1 class="text-2xl font-bold mb-4">Demo Import Progress Dialog</h1>
            <button 
                @click="showDialog = true"
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
                Mở Dialog Import
            </button>
        </div>

        <!-- Import Dialog -->
        <Dialog
            :visible="showDialog"
            @update:visible="showDialog = $event"
            :style="{ 
                width: (isImporting) ? '700px' : '500px', 
                maxWidth: '98vw' 
            }"
            header="Import lịch khám từ Excel"
            :modal="true"
            :closable="!isImporting"
        >
            <div class="p-fluid">
                <!-- File Selection -->
                <div v-if="!isImporting" class="mb-4">
                    <label class="font-bold mb-2 block">Chọn file Excel:</label>
                    <input 
                        type="file" 
                        accept=".xlsx,.xls"
                        @change="onFileSelect"
                        class="w-full p-2 border rounded"
                    />
                </div>

                <!-- Progress Section -->
                <div v-if="isImporting" class="mb-4">
                    <!-- Main Progress Bar -->
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">
                                {{ progress.message || 'Đang import...' }}
                            </span>
                            <span class="text-sm font-bold text-blue-600">{{ progress.progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                class="bg-blue-600 h-3 rounded-full transition-all duration-300"
                                :style="{ width: progress.progress + '%' }"
                            ></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Progress Info -->
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                        <!-- Header with stats -->
                        <div class="flex items-center justify-between mb-3">
                            <h6 class="text-sm font-semibold text-blue-800 flex items-center">
                                <i class="pi pi-chart-line mr-2"></i>
                                Tiến trình import
                            </h6>
                            <div class="flex items-center space-x-3">
                                <!-- Progress stats -->
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">Đã xử lý</div>
                                    <div class="text-sm font-bold text-blue-600">
                                        {{ progress.inserted || 0 }}/{{ progress.total || 0 }}
                                    </div>
                                </div>
                                <!-- Connection status -->
                                <div class="flex items-center">
                                    <div 
                                        class="w-3 h-3 rounded-full mr-2 animate-pulse"
                                        :class="isConnected ? 'bg-green-500' : 'bg-red-500'"
                                    ></div>
                                    <span class="text-xs font-medium" :class="isConnected ? 'text-green-600' : 'text-red-600'">
                                        {{ isConnected ? 'Kết nối' : 'Mất kết nối' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Phase indicators with better styling -->
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div 
                                class="flex items-center justify-center px-3 py-2 rounded-lg text-xs font-medium transition-all duration-300"
                                :class="getPhaseClass('PARSING_EXCEL')"
                            >
                                <i class="pi pi-file-excel mr-2"></i>
                                <span>Đọc Excel</span>
                            </div>
                            <div 
                                class="flex items-center justify-center px-3 py-2 rounded-lg text-xs font-medium transition-all duration-300"
                                :class="getPhaseClass('INSERTING_SLOTS')"
                            >
                                <i class="pi pi-database mr-2"></i>
                                <span>Thêm dữ liệu</span>
                            </div>
                            <div 
                                class="flex items-center justify-center px-3 py-2 rounded-lg text-xs font-medium transition-all duration-300"
                                :class="getPhaseClass('INSERTED_SLOTS')"
                            >
                                <i class="pi pi-check mr-2"></i>
                                <span>Hoàn thành</span>
                            </div>
                        </div>
                        
                        <!-- Error list with better styling -->
                        <div v-if="progress.errors.length > 0" class="mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-red-600 flex items-center">
                                    <i class="pi pi-exclamation-triangle mr-1"></i>
                                    Lỗi phát hiện ({{ progress.errors.length }})
                                </span>
                                <span class="text-xs text-gray-500">Hiển thị 5 lỗi gần nhất</span>
                            </div>
                            <div class="max-h-24 overflow-y-auto bg-red-50 border border-red-200 rounded p-2">
                                <div 
                                    v-for="(error, index) in progress.errors.slice(-5)" 
                                    :key="index"
                                    class="text-xs text-red-700 mb-1 p-1 bg-white rounded border-l-2 border-red-400"
                                >
                                    <span class="font-medium">Dòng {{ error.row }}:</span> {{ error.message }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional info -->
                        <div v-if="progress.total > 0" class="mt-3 text-xs text-gray-600">
                            <div class="flex justify-between">
                                <span>Tốc độ: {{ Math.round((progress.inserted || 0) / (Date.now() - importStartTime) * 1000) || 0 }} records/giây</span>
                                <span>Thời gian ước tính: {{ getEstimatedTime() }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <template #footer>
                <button 
                    @click="closeDialog"
                    :disabled="isImporting"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50"
                >
                    Hủy
                </button>
                <button 
                    @click="startImport"
                    :disabled="!selectedFile || isImporting"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                >
                    {{ isImporting ? 'Đang import...' : 'Import' }}
                </button>
            </template>
        </Dialog>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;

        createApp({
            setup() {
                const showDialog = ref(false);
                const selectedFile = ref(null);
                const isImporting = ref(false);
                const isConnected = ref(true);
                const importStartTime = ref(0);

                const progress = reactive({
                    progress: 0,
                    message: '',
                    inserted: 0,
                    total: 0,
                    currentPhase: null,
                    errors: []
                });

                const phases = {
                    PARSING_EXCEL: 0,
                    INSERTING_SLOTS: 1,
                    INSERTED_SLOTS: 2
                };

                function onFileSelect(event) {
                    selectedFile.value = event.target.files[0];
                }

                function getPhaseClass(phase) {
                    if (!progress.currentPhase) {
                        return 'bg-gray-100 text-gray-500';
                    }
                    
                    const currentPhaseIndex = phases[progress.currentPhase];
                    const targetPhaseIndex = phases[phase];
                    
                    if (targetPhaseIndex < currentPhaseIndex) {
                        return 'bg-green-100 text-green-700';
                    } else if (targetPhaseIndex === currentPhaseIndex) {
                        return 'bg-blue-100 text-blue-700';
                    } else {
                        return 'bg-gray-100 text-gray-500';
                    }
                }

                function getEstimatedTime() {
                    if (!progress.total || !progress.inserted || progress.inserted === 0) {
                        return 'Đang tính toán...';
                    }
                    
                    const elapsed = Date.now() - importStartTime.value;
                    const rate = progress.inserted / elapsed;
                    const remaining = progress.total - progress.inserted;
                    const estimatedMs = remaining / rate;
                    
                    if (estimatedMs < 60000) {
                        return `${Math.round(estimatedMs / 1000)}s`;
                    } else if (estimatedMs < 3600000) {
                        return `${Math.round(estimatedMs / 60000)}m`;
                    } else {
                        return `${Math.round(estimatedMs / 3600000)}h`;
                    }
                }

                function startImport() {
                    if (!selectedFile.value) return;

                    isImporting.value = true;
                    importStartTime.value = Date.now();
                    
                    // Reset progress
                    progress.progress = 0;
                    progress.message = 'Đang khởi tạo import...';
                    progress.inserted = 0;
                    progress.total = 2400; // Simulate total
                    progress.currentPhase = 'PARSING_EXCEL';
                    progress.errors = [];

                    // Simulate import process
                    simulateImport();
                }

                function simulateImport() {
                    // Phase 1: Parsing Excel
                    setTimeout(() => {
                        progress.currentPhase = 'PARSING_EXCEL';
                        progress.message = 'Đang đọc file Excel...';
                        progress.progress = 10;
                    }, 500);

                    // Phase 2: Inserting slots
                    setTimeout(() => {
                        progress.currentPhase = 'INSERTING_SLOTS';
                        progress.message = 'Đang thêm dữ liệu vào database...';
                        
                        // Simulate progressive insertion
                        let inserted = 0;
                        const interval = setInterval(() => {
                            inserted += Math.random() * 50 + 10;
                            if (inserted >= progress.total) {
                                inserted = progress.total;
                                clearInterval(interval);
                                
                                // Phase 3: Completed
                                setTimeout(() => {
                                    progress.currentPhase = 'INSERTED_SLOTS';
                                    progress.message = 'Đã hoàn thành import 2400 slot. Bỏ qua 0 slot vì đã tồn tại. Tổng số lỗi: 3.';
                                    progress.progress = 100;
                                    
                                    setTimeout(() => {
                                        isImporting.value = false;
                                        showDialog.value = false;
                                    }, 2000);
                                }, 500);
                            }
                            
                            progress.inserted = Math.floor(inserted);
                            progress.progress = Math.min(90, 10 + (inserted / progress.total) * 80);
                        }, 200);

                        // Simulate some errors
                        setTimeout(() => {
                            progress.errors.push({
                                row: 8,
                                message: 'Lỗi: Không tìm thấy bác sỹ có mã = ntmm4'
                            });
                        }, 2000);

                        setTimeout(() => {
                            progress.errors.push({
                                row: 15,
                                message: 'Lỗi: Phòng khám không tồn tại'
                            });
                        }, 3000);

                        setTimeout(() => {
                            progress.errors.push({
                                row: 23,
                                message: 'Lỗi: Định dạng ngày không hợp lệ'
                            });
                        }, 4000);

                    }, 2000);
                }

                function closeDialog() {
                    if (!isImporting.value) {
                        showDialog.value = false;
                        selectedFile.value = null;
                    }
                }

                return {
                    showDialog,
                    selectedFile,
                    isImporting,
                    isConnected,
                    importStartTime,
                    progress,
                    onFileSelect,
                    getPhaseClass,
                    getEstimatedTime,
                    startImport,
                    closeDialog
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
