# T√†i li·ªáu H·ªá th·ªëng Ph√¢n quy·ªÅn - BM Patient Hub

## üìã T·ªïng quan

H·ªá th·ªëng ph√¢n quy·ªÅn c·ªßa BM Patient Hub ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ki·ªÉm so√°t quy·ªÅn truy c·∫≠p v√†o c√°c ch·ª©c nƒÉng v√† menu d·ª±a tr√™n permissions t·ª´ API backend. H·ªá th·ªëng s·ª≠ d·ª•ng JWT token ƒë·ªÉ x√°c th·ª±c v√† qu·∫£n l√Ω permissions th√¥ng qua Vue 3 Composition API, Pinia store, v√† custom directives.

## üèóÔ∏è Ki·∫øn tr√∫c H·ªá th·ªëng

### 1. C·∫•u tr√∫c Th∆∞ m·ª•c
```
frontend/src/
‚îú‚îÄ‚îÄ composables/
‚îÇ   ‚îî‚îÄ‚îÄ usePermissions.ts          # Composable ƒë·ªÉ s·ª≠ d·ª•ng permissions
‚îú‚îÄ‚îÄ directives/
‚îÇ   ‚îî‚îÄ‚îÄ permission.directive.ts    # Directive v-permission
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ auth.store.ts             # Pinia store qu·∫£n l√Ω auth & permissions
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ permission.utils.ts       # Utility functions cho permissions
‚îÇ   ‚îî‚îÄ‚îÄ PERMISSION_GUIDE.md       # H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ menu.ts                   # C·∫•u h√¨nh menu v·ªõi permissions
‚îî‚îÄ‚îÄ models/
    ‚îî‚îÄ‚îÄ user.model.ts             # Interface User v·ªõi permissions
```

### 2. Lu·ªìng X·ª≠ l√Ω Permissions
```mermaid
graph TD
    A[User Login] --> B[API /auth/me]
    B --> C[Store User + Permissions]
    C --> D[Menu Filtering]
    C --> E[Route Guards]
    C --> F[Component Permissions]
    D --> G[Sidebar Menu]
    E --> H[Page Access]
    F --> I[UI Elements]
```

## üîê C·∫•u tr√∫c Permissions

### 1. ƒê·ªãnh nghƒ©a Permissions

H·ªá th·ªëng s·ª≠ d·ª•ng 2 lo·∫°i permissions:

#### **CRUD Permissions** (Ch·ª©c nƒÉng)
- `{module}:create` - T·∫°o m·ªõi
- `{module}:read` - Xem/ƒê·ªçc
- `{module}:update` - C·∫≠p nh·∫≠t
- `{module}:delete` - X√≥a

#### **Menu Access Permissions** (Truy c·∫≠p menu)
- `access_menu_{module}` - Quy·ªÅn truy c·∫≠p menu module

### 2. Danh s√°ch Modules hi·ªán t·∫°i

```typescript
// C√°c modules ƒë∆∞·ª£c h·ªó tr·ª£
const MODULES = {
  NOTIFICATION: 'notification',
  SURVEY: 'survey', 
  USER: 'user',
  QUEUE: 'queue',
  APPOINTMENT: 'appointment',
  MEILISEARCH: 'meilisearch'
}
```

### 3. V√≠ d·ª• Permissions t·ª´ API

```json
{
  "data": {
    "userId": 14874,
    "username": "tracnn",
    "fullName": "Nguy·ªÖn Ng·ªçc Tr√°c",
    "email": "tracnn20021979@gmail.com",
    "phoneNumber": "0988795445",
    "permissions": [
      // Notification permissions
      "notification:create",
      "notification:read", 
      "notification:update",
      "notification:delete",
      "access_menu_notification",
      
      // Survey permissions
      "survey:create",
      "survey:update",
      "survey:delete", 
      "survey:read",
      "access_menu_survey",
      
      // User permissions
      "user:create",
      "user:update",
      "user:delete",
      "user:read", 
      "access_menu_user",
      
      // Queue permissions
      "queue:create",
      "queue:update",
      "queue:delete",
      "queue:read",
      "access_menu_queue",
      
      // Appointment permissions
      "appointment:create",
      "appointment:update", 
      "appointment:delete",
      "appointment:read",
      "access_menu_appointment",
      
      // Meilisearch permissions
      "meilisearch:delete",
      "meilisearch:read",
      "meilisearch:update", 
      "meilisearch:create",
      "access_menu_meilisearch"
    ]
  }
}
```

## üéØ Mapping Menu v·ªõi Permissions

### 1. C·∫•u tr√∫c Menu hi·ªán t·∫°i

```typescript
// data/menu.ts
const menuData = {
  main: [
    {
      name: "Dashboard",
      to: "backend-dashboard",        // Kh√¥ng c·∫ßn permission
      icon: "si si-speedometer",
    },
    {
      name: "Qu·∫£n l√Ω App b·ªánh nh√¢n",
      icon: "si si-calendar",
      sub: [
        {
          name: "Danh m·ª•c",
          sub: [
            {
              name: "Chuy√™n khoa",
              to: "backend-specialties",        // C·∫ßn: access_menu_appointment
            },
            {
              name: "Ch·ª©c danh", 
              to: "backend-title",              // C·∫ßn: access_menu_appointment
            },
            {
              name: "Ch·ª©c danh - B√°c sƒ©",
              to: "backend-doctor-title",       // C·∫ßn: access_menu_appointment
            },
            {
              name: "PK - Chuy√™n khoa",
              to: "backend-clinic-specialty",   // C·∫ßn: access_menu_appointment
            },
            {
              name: "Ng∆∞·ªùi d√πng",
              to: "backend-users",              // C·∫ßn: access_menu_user
            },
          ]
        },
        {
          name: "Qu·∫£n l√Ω l·ªãch kh√°m",
          to: "backend-appointment-slots",      // C·∫ßn: access_menu_appointment
        },
        {
          name: "Qu·∫£n l√Ω BN ƒë·∫∑t l·ªãch", 
          to: "backend-appointment-management", // C·∫ßn: access_menu_appointment
        },
        {
          name: "Import l·ªãch kh√°m (Excel)",
          to: "backend-import-appointment-slots", // C·∫ßn: access_menu_appointment
        },
      ],
    },
    {
      name: "Qu·∫£n l√Ω x·∫øp h√†ng",
      icon: "si si-calendar", 
      sub: [
        {
          name: "Danh m·ª•c",
          sub: [
            {
              name: "Ph√≤ng x·∫øp s·ªë",
              to: "backend-queue-room",         // C·∫ßn: access_menu_queue
            },
            {
              name: "Ph√≤ng x·∫øp s·ªë - Th·ª±c hi·ªán",
              to: "backend-queue-clinic-room",  // C·∫ßn: access_menu_queue
            },
          ]
        },
        {
          name: "Qu·∫£n l√Ω x·∫øp h√†ng",
          to: "backend-queue-ticket",           // C·∫ßn: access_menu_queue
        }
      ],
    },
    {
      name: "Kh·∫£o s√°t h√†i l√≤ng",
      to: "backend-satisfaction-survey",        // C·∫ßn: access_menu_survey
      icon: "si si-star",
    },
  ],
}
```

### 2. Menu Permission Mapping

```typescript
// utils/permission.utils.ts
export const MENU_PERMISSIONS = {
  'backend-dashboard': [], // Dashboard kh√¥ng c·∫ßn permission ƒë·∫∑c bi·ªát
  'backend-specialties': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-title': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-users': [PERMISSIONS.ACCESS_MENU_USER],
  'backend-doctor-title': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-clinic-specialty': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-appointment-slots': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-import-appointment-slots': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-appointment-management': [PERMISSIONS.ACCESS_MENU_APPOINTMENT],
  'backend-queue-room': [PERMISSIONS.ACCESS_MENU_QUEUE],
  'backend-queue-clinic-room': [PERMISSIONS.ACCESS_MENU_QUEUE],
  'backend-queue-ticket': [PERMISSIONS.ACCESS_MENU_QUEUE],
  'backend-satisfaction-survey': [PERMISSIONS.ACCESS_MENU_SURVEY],
} as const;
```

## üõ†Ô∏è C√°ch S·ª≠ d·ª•ng

### 1. Trong Components v·ªõi Composable

```vue
<script setup lang="ts">
import { usePermissions } from '@/composables/usePermissions';

const { 
  user, 
  permissions, 
  isAuthenticated,
  hasPermission, 
  hasAnyPermission, 
  hasAllPermissions,
  canAccessRoute,
  isAdmin 
} = usePermissions();

// Ki·ªÉm tra single permission
const canCreateUser = hasPermission('user:create');
const canReadUsers = hasPermission('user:read');

// Ki·ªÉm tra multiple permissions (c√≥ √≠t nh·∫•t 1)
const canManageUsers = hasAnyPermission(['user:create', 'user:update', 'user:delete']);

// Ki·ªÉm tra t·∫•t c·∫£ permissions
const isFullAdmin = hasAllPermissions(['user:create', 'user:update', 'user:delete', 'user:read']);

// Ki·ªÉm tra quy·ªÅn truy c·∫≠p route
const canAccessUserPage = canAccessRoute('backend-users');

// Ki·ªÉm tra admin
const isUserAdmin = isAdmin();
</script>

<template>
  <div>
    <!-- Hi·ªÉn th·ªã n√∫t t·∫°o user n·∫øu c√≥ quy·ªÅn -->
    <button v-if="canCreateUser" @click="createUser">
      T·∫°o ng∆∞·ªùi d√πng m·ªõi
    </button>
    
    <!-- Hi·ªÉn th·ªã danh s√°ch user n·∫øu c√≥ quy·ªÅn ƒë·ªçc -->
    <div v-if="canReadUsers">
      <UserList />
    </div>
    
    <!-- Hi·ªÉn th·ªã menu qu·∫£n l√Ω n·∫øu c√≥ √≠t nh·∫•t 1 quy·ªÅn -->
    <div v-if="canManageUsers">
      <UserManagementMenu />
    </div>
  </div>
</template>
```

### 2. Trong Template v·ªõi Directive

```vue
<template>
  <!-- Single permission -->
  <button v-permission="'user:create'">T·∫°o ng∆∞·ªùi d√πng</button>
  <button v-permission="'user:delete'">X√≥a ng∆∞·ªùi d√πng</button>

  <!-- Multiple permissions (c√≥ √≠t nh·∫•t 1) -->
  <button v-permission="['user:create', 'user:update']">
    Qu·∫£n l√Ω ng∆∞·ªùi d√πng
  </button>

  <!-- Object v·ªõi mode -->
  <button v-permission="{ 
    permissions: ['user:create', 'user:update'], 
    mode: 'all' 
  }">
    Quy·ªÅn ƒë·∫ßy ƒë·ªß
  </button>
  
  <!-- Menu items -->
  <nav v-permission="'access_menu_user'">
    <a href="/users">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
  </nav>
</template>
```

### 3. Trong Router Guards

```typescript
// router/index.ts
import { useAuthStore } from '@/stores/auth.store';
import PermissionUtils from '@/utils/permission.utils';

const router = createRouter({
  // ... routes
});

router.beforeEach((to, from, next) => {
  const authStore = useAuthStore();
  
  // Ki·ªÉm tra authentication
  if (to.meta.requiresAuth && !authStore.getIsAuthenticated) {
    next('/auth/signin');
    return;
  }
  
  // Ki·ªÉm tra permission
  if (to.meta.requiresPermission) {
    const hasPermission = PermissionUtils.hasPermission(to.meta.requiresPermission);
    if (!hasPermission) {
      next('/errors/403'); // Chuy·ªÉn ƒë·∫øn trang 403
      return;
    }
  }
  
  // Ki·ªÉm tra route access
  if (!PermissionUtils.canAccessRoute(to.name as string)) {
    next('/errors/403');
    return;
  }
  
  next();
});
```

### 4. Trong Menu Component

```vue
<script setup lang="ts">
import { computed } from 'vue';
import { usePermissions } from '@/composables/usePermissions';
import menuData from '@/data/menu.ts';
import PermissionUtils from '@/utils/permission.utils';

const { canAccessRoute } = usePermissions();

// L·ªçc menu d·ª±a tr√™n permissions
const filteredMenu = computed(() => {
  return PermissionUtils.filterMenuByPermissions(menuData.main);
});
</script>

<template>
  <nav>
    <ul v-for="item in filteredMenu" :key="item.name">
      <li>
        <router-link 
          v-if="item.to" 
          :to="{ name: item.to }"
          :class="{ active: $route.name === item.to }"
        >
          <i :class="item.icon"></i>
          {{ item.name }}
        </router-link>
        
        <!-- Sub menu -->
        <ul v-if="item.sub" class="sub-menu">
          <li v-for="subItem in item.sub" :key="subItem.name">
            <router-link 
              v-if="subItem.to" 
              :to="{ name: subItem.to }"
            >
              {{ subItem.name }}
            </router-link>
          </li>
        </ul>
      </li>
    </ul>
  </nav>
</template>
```

## üîß API Integration

### 1. Endpoint l·∫•y th√¥ng tin user v√† permissions

```bash
curl -X 'GET' \
  'http://localhost:7111/admin/auth/me' \
  -H 'accept: */*' \
  -H 'Authorization: Bearer {JWT_TOKEN}'
```

### 2. Response Format

```json
{
  "data": {
    "userId": 14874,
    "username": "tracnn",
    "fullName": "Nguy·ªÖn Ng·ªçc Tr√°c", 
    "email": "tracnn20021979@gmail.com",
    "phoneNumber": "0988795445",
    "permissions": [
      "notification:create",
      "notification:read",
      "notification:update", 
      "notification:delete",
      "access_menu_notification",
      "survey:create",
      "survey:update",
      "survey:delete",
      "survey:read",
      "access_menu_survey",
      "user:create",
      "user:update",
      "user:delete",
      "user:read",
      "access_menu_user",
      "queue:create",
      "queue:update",
      "queue:delete", 
      "queue:read",
      "access_menu_queue",
      "appointment:create",
      "appointment:update",
      "appointment:delete",
      "appointment:read",
      "access_menu_appointment",
      "meilisearch:delete",
      "meilisearch:read",
      "meilisearch:update",
      "meilisearch:create",
      "access_menu_meilisearch"
    ]
  },
  "pagination": null,
  "status": 200,
  "message": "Success",
  "now": "2025-09-12 07:29:06.830"
}
```

### 3. Auth Store Integration

```typescript
// stores/auth.store.ts
export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,
    isAuthenticated: false,
    // ...
  }),

  actions: {
    async checkAuth(): Promise<boolean> {
      try {
        const user = await authService.getCurrentUser();
        this.setUser(user); // user.permissions ƒë∆∞·ª£c l∆∞u v√†o store
        return true;
      } catch (error) {
        this.logout();
        return false;
      }
    },
    
    setUser(user: User | null): void {
      this.user = user;
      this.isAuthenticated = !!user;
    }
  }
});
```

## üìù Th√™m Permission M·ªõi

### 1. Th√™m Permission Constants

```typescript
// utils/permission.utils.ts
export const PERMISSIONS = {
  // ... existing permissions
  
  // New module permissions
  NEW_MODULE_CREATE: 'new_module:create',
  NEW_MODULE_READ: 'new_module:read', 
  NEW_MODULE_UPDATE: 'new_module:update',
  NEW_MODULE_DELETE: 'new_module:delete',
  ACCESS_MENU_NEW_MODULE: 'access_menu_new_module',
} as const;
```

### 2. Th√™m Menu Permission Mapping

```typescript
export const MENU_PERMISSIONS = {
  // ... existing mappings
  
  'backend-new-module': [PERMISSIONS.ACCESS_MENU_NEW_MODULE],
  'backend-new-module-list': [PERMISSIONS.ACCESS_MENU_NEW_MODULE],
  'backend-new-module-create': [PERMISSIONS.ACCESS_MENU_NEW_MODULE],
} as const;
```

### 3. Th√™m Route v·ªõi Permission

```typescript
// router/index.ts
{
  path: "new-module",
  name: "backend-new-module",
  component: NewModuleComponent,
  meta: { 
    layout: LayoutBackend,
    requiresAuth: true,
    requiresPermission: "access_menu_new_module"
  },
}
```

### 4. C·∫≠p nh·∫≠t Menu Data

```typescript
// data/menu.ts
{
  name: "Module M·ªõi",
  to: "backend-new-module",
  icon: "si si-puzzle",
}
```

## üö® Error Handling

### 1. Route Access Denied

```typescript
// Khi user kh√¥ng c√≥ quy·ªÅn truy c·∫≠p route
if (!PermissionUtils.canAccessRoute(routeName)) {
  // Chuy·ªÉn ƒë·∫øn trang 403
  router.push('/errors/403');
}
```

### 2. Menu Item Hidden

```typescript
// Menu items t·ª± ƒë·ªông b·ªã ·∫©n n·∫øu user kh√¥ng c√≥ quy·ªÅn
const filteredMenu = PermissionUtils.filterMenuByPermissions(menuItems);
// Ch·ªâ hi·ªÉn th·ªã items m√† user c√≥ quy·ªÅn
```

### 3. UI Element Hidden

```vue
<!-- Element t·ª± ƒë·ªông b·ªã ·∫©n v·ªõi directive -->
<button v-permission="'user:delete'">X√≥a</button>
<!-- N·∫øu kh√¥ng c√≥ quy·ªÅn, button s·∫Ω b·ªã ·∫©n -->
```

## üß™ Testing

### 1. Unit Tests

```typescript
// tests/permission.utils.test.ts
import PermissionUtils from '@/utils/permission.utils';

describe('PermissionUtils', () => {
  beforeEach(() => {
    // Mock user v·ªõi permissions
    const mockUser = {
      permissions: ['user:read', 'user:create', 'access_menu_user']
    };
    // Set mock user v√†o store
  });

  test('should check single permission', () => {
    expect(PermissionUtils.hasPermission('user:read')).toBe(true);
    expect(PermissionUtils.hasPermission('user:delete')).toBe(false);
  });

  test('should check multiple permissions', () => {
    expect(PermissionUtils.hasAnyPermission(['user:read', 'user:delete'])).toBe(true);
    expect(PermissionUtils.hasAllPermissions(['user:read', 'user:create'])).toBe(true);
  });

  test('should check route access', () => {
    expect(PermissionUtils.canAccessRoute('backend-users')).toBe(true);
    expect(PermissionUtils.canAccessRoute('backend-admin')).toBe(false);
  });
});
```

### 2. Component Tests

```typescript
// tests/UserManagement.test.ts
import { mount } from '@vue/test-utils';
import UserManagement from '@/components/UserManagement.vue';
import { usePermissions } from '@/composables/usePermissions';

test('should show create button when user has permission', () => {
  // Mock permissions
  vi.mocked(usePermissions).mockReturnValue({
    hasPermission: vi.fn().mockReturnValue(true)
  });

  const wrapper = mount(UserManagement);
  expect(wrapper.find('[data-test="create-button"]').exists()).toBe(true);
});
```

## üìä Monitoring & Debugging

### 1. Debug Permissions

```typescript
// Trong component
const { permissions, user } = usePermissions();

// Log permissions ƒë·ªÉ debug
console.log('User permissions:', permissions.value);
console.log('User info:', user.value);
```

### 2. Permission Check Logging

```typescript
// utils/permission.utils.ts
static hasPermission(permission: string): boolean {
  const authStore = useAuthStore();
  const user = authStore.getUser;
  
  const hasPermission = user?.permissions?.includes(permission) || false;
  
  // Debug logging
  if (process.env.NODE_ENV === 'development') {
    console.log(`Permission check: ${permission} = ${hasPermission}`);
  }
  
  return hasPermission;
}
```

## üîí Security Best Practices

### 1. Frontend Security

- **Kh√¥ng tin t∆∞·ªüng ho√†n to√†n v√†o frontend**: Frontend ch·ªâ ƒë·ªÉ UX, backend ph·∫£i validate permissions
- **JWT Token Security**: Token ƒë∆∞·ª£c l∆∞u trong localStorage, c√≥ expiration time
- **Route Guards**: T·∫•t c·∫£ protected routes ƒë·ªÅu c√≥ guards
- **Menu Filtering**: Menu ƒë∆∞·ª£c filter d·ª±a tr√™n permissions th·ª±c t·∫ø

### 2. Backend Integration

- **API Validation**: M·ªçi API call ƒë·ªÅu ph·∫£i validate permissions ·ªü backend
- **Token Refresh**: T·ª± ƒë·ªông refresh token khi g·∫ßn h·∫øt h·∫°n
- **Error Handling**: X·ª≠ l√Ω l·ªói 401/403 m·ªôt c√°ch graceful

## üìö T√†i li·ªáu Tham kh·∫£o

- [Vue 3 Composition API](https://vuejs.org/guide/composition-api/)
- [Pinia Store](https://pinia.vuejs.org/)
- [Vue Router Guards](https://router.vuejs.org/guide/advanced/navigation-guards.html)
- [JWT Token](https://jwt.io/)
- [Vue 3 Directives](https://vuejs.org/guide/reusability/custom-directives.html)

---

**L∆∞u √Ω**: T√†i li·ªáu n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo c·∫•u tr√∫c hi·ªán t·∫°i c·ªßa project. Khi c√≥ thay ƒë·ªïi v·ªÅ permissions ho·∫∑c modules m·ªõi, c·∫ßn c·∫≠p nh·∫≠t t√†i li·ªáu t∆∞∆°ng ·ª©ng.
